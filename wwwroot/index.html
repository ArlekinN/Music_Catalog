<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Музыка</title>
    <link rel="stylesheet" href="StyleSheet.css">
</head>
<body style="background-color:gray">
    <h1>Каталог Музыки</h1>
    <div style="display:flex">
        <h2 style=" margin-block-start: 25px">Найди то, что хочется ТЕБЕ:</h2>
        <! --  ПОИСК  -->
        <ul class="parametersSearch" id="criterion_search">
            <li>
                <div class="dropdown">
                    Музыка
                    <div class="dropdown-content">

                        <p class="dropdown-content-element" onclick="UpdateSearch('Музыка', 'Название')">
                           Название
                        </p>
                        <p class="dropdown-content-element" onclick="UpdateSearch('Музыка', 'Автор')">
                            Автор
                        </p>
                        <p class="dropdown-content-element" onclick="UpdateSearch('Музыка', 'Жанр')">
                            Жанр
                        </p>
                    </div>
                </div>
            </li>
            <li>
                <p style="margin-block-start: 15px; color: aqua; " onclick="UpdateSearch('Автор')">Автор</p>
            </li>
            <li>
                <p style="margin-block-start: 15px; color: aqua; " onclick="UpdateSearch('Альбом')">Альбом</p>
            </li>
            <li>
                <p style="margin-block-start: 15px; color: aqua; " onclick="UpdateSearch('Сборник')">Сборник</p>
            </li>
        </ul>
    </div>

    <! --  ФОРМА ПОИСКА  -->
    <form method="post" class="search-input">
        <div>Поиск по <span style="color: greenyellow;" id="selectid_criterion_search"></span> </div>
        <input id="search" style="margin-block-start: 10px; z-index: 100" />
        <input type="button" value="Поиск" onclick="Search()" />
    </form>
    <div id="resultsContainer" style="position: relative; top: 25px; z-index: 99"></div>
    <input type="button" value="Добавить" onclick="window.windowAddData.showModal()" class="add-bth" />

    <! -- ДОБАВЛЕНИЕ ЧЕГО-ЛИБО -->
    <dialog id="windowAddData" style="position: relative; padding-bottom: 25px">
        <h2>Добавление информации в каталог</h2>
        <ul class="element-add-main-menu" onclick="ChangeActiveMainMenu()">
            <li onclick="CloseMainWindow(); window.windowArtist.show()">
                Автор
            </li>
            <li onclick="CloseMainWindow(); window.windowSong.show()">
                Песня
            </li>
            <li onclick="CloseMainWindow(); window.windowAlbum.show()">
                Альбом
            </li>
            <li onclick="CloseMainWindow(); window.windowCollection.show()">
                Сборник
            </li>
        </ul>

        <! -- ОКНО ДЛЯ ПЕВЦА -->
        <dialog id="windowArtist" class="modalWindowData">
            <div style="display: flex;">
                <p class="value-parametr">Имя</p>
                <input class="value-input"  id="value-artist-MArtist" type="text"/>
            </div>
        </dialog>

        <! -- ОКНО ДЛЯ ПЕСНИ -->
        <dialog id="windowSong" class="modalWindowData">
            <div style="display: flex; ">
                <p class="value-parametr">Название</p>
                <input class="value-input" />
            </div>
            <div style="display: flex;">
                <p class="value-parametr">Артист</p>
                <input class="value-input" />
            </div>
            <div style="display: flex;">
                <p class="value-parametr">Альбом</p>
                <input class="value-input" />
            </div>
            <div style="display: flex;">
                <p class="value-parametr">Продолжительность</p>
                <input class="value-input" />
            </div>
            <div style="display: flex;">
                <p class="value-parametr">Год релиза</p>
                <input class="value-input" />
            </div>
            <div style="display: flex;">
                <p class="value-parametr">Жанр</p>
                <input class="value-input" />
            </div>
        </dialog>

        <! -- ОКНО ДЛЯ АЛЬБОМ -->
        <dialog id="windowAlbum" class="modalWindowData">
            <div style="display: flex; ">
                <p class="value-parametr">Название</p>
                <input class="value-input" id="value-album-MAlbum" />
            </div>
            <div style="display: flex;">
                <p class="value-parametr">Артист</p>
                <div><input type="text" id="album-artist-search" placeholder="артист..." oninput="SearchArtist('album-artist-search','dropdown-results-album-artist')"></div>
                <div id="dropdown-results-album-artist" class="dropdown-results"></div>
            </div>
            <div style="display: flex;">
                <p class="value-parametr">Год релиза</p>
                <input class="value-input" id="value-year-MAlbum" />
            </div>
            <div style="display: flex;">
                <p class="value-parametr">Жанр</p>
                <select name="genre" id="album-genre-select">
                    <option value="">Выберите жанр</option>
                </select>
            </div>
        </dialog>
        <! -- ОКНО ДЛЯ СБОРНИКА -->
        <dialog id="windowCollection" class="modalWindowData">
            <ul class="element-add-collection-menu" onclick="ChangeActiveCollectionMenu()">
                <li style="width:auto" onclick="CloseCollectionWindow(); windowCollectionCreate.show()">
                    Создать сборник
                </li>
                <li style="width:auto; margin-left:20px" onclick="CloseCollectionWindow(); windowCollectionAddSong.show()">
                    Добавить песню в сборник
                </li>
            </ul>
            <! -- ОКНО ДЛЯ СОЗДАНИЯ СБОРНИКА -->
            <dialog id="windowCollectionCreate" class="modalWindowData">
                <div style="display: flex; ">
                    <p class="value-parametr">Название сборника</p>
                    <input class="value-input" />
                </div>
                <ul class="element-add-collection-add-song" onclick="ChangeActiveCollectionTypeMenu()">
                    <li style="width: auto;" onclick="CloseCollectionTypeWindow();windowCollectionEpoch.show()">
                        Эпоха
                    </li>
                    <li style="width: auto; margin-left:20px" onclick="CloseCollectionTypeWindow(); window.windowCollectionGenre.show()">
                        Жанр
                    </li>
                </ul>
                <! -- ОКНО ДЛЯ СОЗДАНИЯ СБОРНИКА ПО ЭПОХЕ-->
                <dialog id="windowCollectionEpoch" class="modalWindowData">
                    <div style="display: flex; ">
                        <p class="value-parametr">Жанр</p>
                        <input class="value-input" style="margin-left:22px" />
                    </div>
                </dialog>
                <! -- ОКНО ДЛЯ СОЗДАНИЯ СБОРНИКА ПО ЖАНРУ-->
                <dialog id="windowCollectionGenre" class="modalWindowData">
                    <div style="display: flex; ">
                        <p class="value-parametr">Год релиза</p>
                        <input class="value-input" />
                    </div>
                </dialog>
            </dialog>
            <! -- ОКНО ДЛЯ ДОБАВЛЕНИЯ ПЕСНИ В СБОРНИК-->
            <dialog id="windowCollectionAddSong" class="modalWindowData">
                <div style="display: flex; ">
                    <p class="value-parametr">Название сборника</p>
                    <input class="value-input" />
                </div>
                <div style="display: flex; ">
                    <p class="value-parametr">Название песни</p>
                    <input class="value-input" />
                </div>
                <div style="padding-bottom:20px">
                    <input type="radio" id="epoch" name="typeCollection" value="Жанр" />
                    <label for="epoch">Жанр</label>

                    <input type="radio" id="genre" name="typeCollection" value="Эпоха" />
                    <label for="genre">Эпоха</label>
                </div>
            </dialog>
        </dialog>
        <div style="position:absolute; bottom:5px">
            <input type="button" value="Создать" onclick="Create()" />
            <input type="button" value="Закрыть" onclick="CloseAllWindow()" />
        </div>
    </dialog>

</body>
</html>

<script>
    // выбор критериев поиска
    async function UpdateSearch(criterion, subCriterion) {
        const searchText = subCriterion ? `${criterion} ${subCriterion}` : criterion;
        document.getElementById('selectid_criterion_search').innerText = searchText;
    }

    // поиск
   async function Search() {
        var parametrSearch = document.getElementById('search').value;
        var parametrFilter = document.getElementById('selectid_criterion_search').innerText;
       if (parametrFilter == "Автор") {
           GetArtists(parametrSearch);
       }
       else if (parametrFilter.includes("Альбом")) {
           GetAlbum(parametrSearch);
       }
       else if (parametrFilter.includes("Музыка")) {
           GetMusic(parametrSearch);
       }
    }
    window.onload = function () {
        ChangeActiveMainMenu();
        GetGenres();
    }
    // изменение активного элемента меню
    function ChangeActiveMainMenu() {
        const listItems = document.querySelectorAll('.element-add-main-menu li')
        listItems.forEach(item => {
            item.addEventListener('click', () => {
                listItems.forEach(i => i.classList.remove('active')); 
                item.classList.add('active'); 
            });
        });
    }
    function ChangeActiveCollectionMenu() {
        const listItems = document.querySelectorAll('.element-add-collection-menu li')
        listItems.forEach(item => {
            item.addEventListener('click', () => {
                listItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            });
        });
    }
    function ChangeActiveCollectionTypeMenu() {
        const listItems = document.querySelectorAll('.element-add-collection-add-song li')
        listItems.forEach(item => {
            item.addEventListener('click', () => {
                listItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            });
        });
    }
    // закрытие модальных окон
    function CloseAllWindow() {
        CloseMainWindow();
        CloseCollectionWindow();
        CloseCollectionTypeWindow();
        windowAddData.close();
    }
    function CloseMainWindow() {
        window.windowArtist.close();
        window.windowSong.close();
        window.windowAlbum.close();
        window.windowCollection.close();
    }
    function CloseCollectionWindow() {
        window.windowCollectionCreate.close();
        window.windowCollectionAddSong.close();
    }
    function CloseCollectionTypeWindow() {
        window.windowCollectionEpoch.close();
        window.windowCollectionGenre.close();
    }
    // ПОЛУЧЕНИЕ 
    // получение таблицы с артистами
    async function GetArtists(parametrSearch) {
        const response = await fetch("/api/artists", {
            method: "GET",
            headers: { "Accept": "application/json" }
        }); 
        const resultsContainer = document.getElementById('resultsContainer');
        resultsContainer.innerHTML = '';
        if (response.ok === true) {
            var artists = await response.json();
            if (parametrSearch != "") {
                artists = artists.filter(artist => artist.name.toLowerCase().includes(parametrSearch.toLowerCase()));
            }
            if (artists.length === 0) {
                const row = document.createElement("tr");
                row.innerHTML = `<td>Нет результатов</td>`;
                resultsContainer.appendChild(row);
            }
            else {
                const table = document.createElement("table");
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Артист</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${artists.map(artist => `<tr><td>${artist.name}</td></tr>`).join('')}
                    </tbody>
                `;
                document.getElementById('resultsContainer').appendChild(table);
            }
        }
    }
    // получение таблицы с альбомами 
    async function GetAlbum(parametrSearch) {
        const response = await fetch("/api/albums", {
            method: "GET",
            headers: { "Accept": "application/json" }
        });;
        const resultsContainer = document.getElementById('resultsContainer');
        resultsContainer.innerHTML = '';
        if (response.ok === true) {
            var albums = await response.json();
            if (parametrSearch != "") {
                albums = albums.filter(album => album.title.toLowerCase().includes(parametrSearch.toLowerCase()));
                    
            }
            if (albums.length === 0) {
                const row = document.createElement("tr");
                row.innerHTML = `<td>Нет результатов</td>`;
                resultsContainer.appendChild(row);
            }
            else {
                for (const album of albums) 
                {
                    const responseAlbum = await fetch(`/api/genres/${album.genreId}`, {
                        method: "GET",
                        headers: { "Accept": "application/json" }
                    });
                    if (responseAlbum.ok === true) {
                        var genre = await responseAlbum.json();
                        album.genre = genre;
                    }
                    const responseArtist = await fetch(`/api/artists/${album.artistId}`, {
                        method: "GET",
                        headers: { "Accept": "application/json" }
                    });
                    if (responseArtist.ok === true) {
                        var artist = await responseArtist.json();
                        album.artist = artist;
                    }
                }
                const table = document.createElement("table");
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Артист</th>
                            <th>Год релиза</th>
                            <th>Жанр</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${albums.map(album => `
                    <tr>
                        <td>${album.title}</td> 
                        <td>${album.artist.name }</td>
                        <td>${album.yearRelease}</td>
                        <td>${album.genre.title}</td>
                    </tr>
                `).join('')}
                    </tbody>
                `;
                document.getElementById('resultsContainer').appendChild(table);
            }
        }
    }
    async function GetMusic(parametrSearch) {
        const response = await fetch("/api/songs", {
            method: "GET",
            headers: { "Accept": "application/json" }
        });;
        const resultsContainer = document.getElementById('resultsContainer');
        resultsContainer.innerHTML = '';
        if (response.ok === true) {
            var songs = await response.json();
            if (parametrSearch != "") {
                songs = songs.filter(song => song.title.toLowerCase().includes(parametrSearch.toLowerCase()));
            }
            if (songs.length === 0) {
                const row = document.createElement("tr");
                row.innerHTML = `<td>Нет результатов</td>`;
                resultsContainer.appendChild(row);
            }
            else {
                for (const song of songs) {
                    const responseGenre = await fetch(`/api/genres/${song.genreId}`, {
                        method: "GET",
                        headers: { "Accept": "application/json" }
                    });
                    if (responseGenre.ok === true) {
                        var genre = await responseGenre.json();
                        song.genre = genre;
                    }
                    const responseArtist = await fetch(`/api/artists/${song.artistId}`, {
                        method: "GET",
                        headers: { "Accept": "application/json" }
                    });
                    if (responseArtist.ok === true) {
                        var artist = await responseArtist.json();
                        song.artist = artist;
                    }
                    const responseAlbum = await fetch(`/api/albums/${song.albumId}`, {
                        method: "GET",
                        headers: { "Accept": "application/json" }
                    });
                    if (responseAlbum.ok === true) {
                        var album = await responseAlbum.json();
                        song.album = album;
                    }
                }
                const table = document.createElement("table");
                table.innerHTML = `
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Артист</th>
                    <th>Год релиза</th>
                    <th>Жанр</th>
                    <th>Альбом</th>
                </tr>
            </thead>
            <tbody>
                ${songs.map(song => `
            <tr>
                <td>${song.title}</td> 
                <td>${song.artist.name}</td>
                <td>${song.yearRelease}</td>
                <td>${song.genre.title}</td>
                <td>${song.album.title}</td>
            </tr>
        `).join('')}
            </tbody>
        `;
                document.getElementById('resultsContainer').appendChild(table);
            }
        }

    }

    // получение списка жанров для выпадающего списка
    async function GetGenres() {
        const response = await fetch("/api/genres", {
            method: "GET",
            headers: { "Accept": "application/json" }
        });
        if (response.ok) {
            const genres = await response.json();
            const genreSelect = document.getElementById("album-genre-select");
            genres.forEach(genre => {
                const option = document.createElement("option");
                option.value = genre.id;
                option.textContent = genre.title;
                genreSelect.appendChild(option);
            });
        }
    }
    // поиск артиста по имени в input
    let selectedArtistAlbum = null;
    async function SearchArtist(idinput, iddropdown) {
        const input = document.getElementById(idinput);
        const dropdown = document.getElementById(iddropdown);
        const query = input.value.trim().toLowerCase();

        if (query.length < 1) { 
            dropdown.style.display = "none";
            return;
        }
        const response = await fetch(`/api/artists`);
        if (response.ok) {
            const artists = await response.json();

            const filteredArtists = artists.filter(artist =>
                artist.name.toLowerCase().includes(query)
            );
            dropdown.innerHTML = "";
            if (filteredArtists.length > 0) {
                dropdown.style.display = "block";
                filteredArtists.forEach(artist => {
                    const item = document.createElement("div");
                    item.classList.add("dropdown-item");
                    item.textContent = artist.name;
                    item.onclick = () => {
                        input.value = artist.name;
                        dropdown.style.display = "none";
                        selectedArtistAlbum = artist.id;
                    };

                    dropdown.appendChild(item);
                });
            } else {
                dropdown.style.display = "none";
            }
        }
    }

    // Закрываем выпадающий список, если кликнули вне поля ввода
    document.addEventListener("click", function (event) {
        const dropdown = document.getElementById("dropdown-results-album-artist");
        if (!event.target.closest("#album-artist-search")) {
            dropdown.style.display = "none";
        }
    });


    // ДОБАВЛЕНИЕ
    function Create() {
        const itemMenu1 = document.querySelectorAll('.element-add-main-menu li.active')
        const itemMenu2 = document.querySelectorAll('.element-add-collection-menu li')
        const itemMenu3 = document.querySelectorAll('.element-add-collection-add-song li')
        if (itemMenu1[0].innerText == "Автор") {
            CreateArtist();
        }
        else if (itemMenu1[0].innerText == "Альбом") {
            CreateAlbum();
        }
    }
    //артист
    async function CreateArtist() {
        const artistInput = document.getElementById("value-artist-MArtist")
        if (artistInput) {
            const artist = artistInput.value;
            const response = await fetch("api/artists", {
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    name: artist
                })
            });
            if (response.ok === true) {
                
            }
            else {
                const error = await response.json();
                console.log(error.message);
            }
        }
    }
    // албом
    async function CreateAlbum() {
        const albumInput = document.getElementById("value-album-MAlbum").value;
        const yearInput = parseInt(document.getElementById("value-year-MAlbum").value);
        const artistId = selectedArtistAlbum;
        const selectElement = document.getElementById("album-genre-select");
        const genreId = parseInt(selectElement.value);
        if (albumInput && yearInput && artist && genre) { 
            const response = await fetch("api/albums", {
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    title: albumInput,
                    yearRelease: yearInput,
                    genreId: genreId,
                    artistId: artistId
                })
            });
            if (response.ok === true) {

            }
            else {
                const errorText = await response.text(); 
                console.error("Ошибка:", errorText); 
            }
        }
        
        

    }
    
</script>